# 字符串的扩展

> Ref: https://es6.ruanyifeng.com/#docs/string

[toc]

## 1. 模板字符串

模板字符串 (template string) 是增强版的字符串，用反引号 (\`) 标识。它可以当作普通字符串使用，也可以用来定义多行字符串，或者在字符串中嵌入变量

如果使用模板字符串表示多行字符串，所有的空格和绥靖都会被保留在输出之中。

```js
console.log(`string text line 1\n---
string text line 2`);

// string text line 1
// ---
// string text line 2
```

## 2. 实例：模板编译

> 一个通过模板字符串，生成正式模板的实例。

```js
let template = `
<ul>
  <% for (let i=0; i<data.supplies.length; i++) { %>
    <li><%= data.supplies[i] %></li>
  <% } %>
</ul>
`;
```

上面代码在模板字符串之中，放置了一个常规模板。该模板使用`<% ... %>`放置 JavaScript 代码，使用`<%= ... %>`输出 JavaScript 表达式。

如何编译这个模板字符串呢？一种思路是将其转换为 JavaScript 表达式字符串。

```js
echo('<ul>');
for (let i=0; i<data.supplies.length; i++) {
  echo('<li>');
  echo(data.supplies[i]);
  echo('</li>');
};
echo('</ul>');
```

这个转换可以使用正则表达式。

```js
const evalExpr = /<%=(.+?)%>/g; // +? 贪婪匹配：尽可能匹配最长的字符串
const expr = /<%([\s\S]+?)%>/g;

// $1 表示正则表达式中小括号里面的小正则捕获到的内容
// Ref: https://www.cnblogs.com/leaf930814/p/7825288.html
template = template
  .replace(evalExpr, '`); \n echo( $1 ); \n echo(`')
  .replace(expr, '`); \n $1 \n echo(`)');

template = 'echo(`' + template + '`);';
```

然后，将`template`封装在一个函数里面返回，就可以了。

最后，将上面的内容封装成一个模板编译函数`compile`。

```js
function compile(template) {
  const evalExpr = /<%=(.+?)%>/g;
  const expr = /<%([\s\S]+?)%>/g;

  template = template
    .replace(evalExpr, '`);\n echo( $1 ); \n echo(`')
    .replace(expr, '`);\n $1 \n echo(`');

  template = 'echo(`' + template + '`);';

  let script = 
  `(function parse(data) {
    let output = "";

    function echo(html) {
      output += html;
    }

    ${ template }

    return output;
  })`;

  return script;
}
```

`compile`函数的用法如下。

```js
let parse = eval(compile(temlate));
div.innerHTML = parse({
  supplies: ['broom', 'mop', 'cleaner']
});

// <ul>
//   <li>broom</li>
//   <li>mop</li>
//   <li>cleaner</li>
// </ul>
```

## 3. 标签模板

模板字符串可以紧跟在一个函数名后面，该函数将被调用来处理这个模板字符串。这被称为“标签模板”功能 (tagged template) 。

```js
let sth = 'world';

alert`hello`
// 等同于
alert(['hello'])

alert`hello ${sth}!`
// 等同于
alert(['hello ', '!', raw: Array(2)], 'world')
```

标签模板其实不是模板，而是函数调用的一种特殊形式。“标签”指的就是函数，紧跟在后面的模板字符串就是它的参数。

但是，如果模板字符里面有变量，就不是简单的调用了，而是会将模板字符串先处理成多个参数，再调用函数。

- 第一个参数是一个字符串数组，由模板字符串根据每个占位符`${...}`进行分割（split）得来；（数组的长度为`模板字符串嵌入变量数 + 1`）；
- 从第二个参数开始，每个参数就依次是嵌入模板字符串的变量作为实参传入。

### 应用

标签模板的重要应用，就是过滤 HTML 字符串，防止用户输入恶意内容。

```js
let message = 
  SaferHTML`<p>${sender} has sent you a message</p>`;

function SaferHTML(templateData, ...values) {
  let s = templateData[0];
  for (let i=0, len=values.length; i<length; i++) {
    let arg = String(values[i]);
    
    // Escape special characters in the substitution.
    s += arg.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    
    // Don't escape special characters in the template.
    s += templateData[i+1];
  }
  return s;
}
```

标签模板的另一个应用，就是多语言转换（国际化处理）。

```js
i18n`Welcome to ${siteName} you are visitor number ${vistorNumber}`
// "欢迎访问xxx网站，您是第xxx为访客！"
```

### raw

模板处理函数的第一个参数（模板字符串数组），还有一个`raw`属性

```js
console.log`123`
// ["123", raw: Array(1)]
```

上面代码中，`console.log`接收的参数，实际上是一个数组。该数组有一个`raw`属性，保存的是原字符串**转义后**的结果。

```js
tag`First line\nSecond line`

function tag(strings) {
  console.log(strings.raw[0]);
  // strings.raw[0] 的值为 "First line\\nSecond line"
  // 控制台打印输出 "First line\nSecond line"
}
```

上面代码中，`tag`函数的第一个参数`strings`有一个`raw`属性，也指向一个数组。该数组的成员与`strings`数组完全一致^*^。两者唯一的区别，就是字符串里面的斜杠被转义了。比如，`string.raw`数组会将`\n`视为`\\`和`n`两个字符，而不是换行符。这是为了方便取得转移之前的原始模板而设计的。

# 字符串的新增方法

> Ref: https://es6.ruanyifeng.com/#docs/string-methods

## 1. String.fromCodePoint()







